<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deye Force Discharger</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 15px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: #4ecca3; font-size: 1.5rem; }
        .card {
            background: #16213e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .card h2 {
            color: #4ecca3;
            margin-bottom: 12px;
            font-size: 1rem;
            border-bottom: 1px solid #2a3f5f;
            padding-bottom: 8px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        @media (min-width: 500px) {
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
        .status-item {
            background: #1a1a2e;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .status-item .label { font-size: 0.7rem; color: #888; margin-bottom: 4px; }
        .status-item .value { font-size: 1.3rem; font-weight: bold; }
        .status-item .value.active { color: #4ecca3; }
        .status-item .value.inactive { color: #e94560; }
        .status-item .value.charging { color: #3498db; }
        .status-item .sub-label { font-size: 0.65rem; color: #666; margin-top: 2px; }

        /* Gauge Sections */
        .gauge-section {
            margin-top: 12px;
            padding: 10px;
            background: #1a1a2e;
            border-radius: 8px;
        }
        .gauge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .gauge-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .gauge-value {
            font-size: 0.9rem;
            font-weight: bold;
            color: #4ecca3;
        }

        /* Power Gauge */
        .power-gauge-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .power-gauge {
            flex: 1;
            height: 24px;
            background: #0d1321;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        .power-gauge-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #4ecca3, #ffc107, #e94560);
        }
        .power-gauge-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 3px rgba(0,0,0,0.8);
        }
        .power-info {
            text-align: right;
            min-width: 100px;
        }
        .power-value { font-size: 1.2rem; font-weight: bold; color: #4ecca3; }
        .power-max { font-size: 0.7rem; color: #666; }

        /* SoC Bar */
        .soc-section { margin-top: 12px; }
        .soc-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .soc-header span { font-size: 0.75rem; color: #888; }
        .soc-bar {
            height: 16px;
            background: #0d1321;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .soc-fill {
            height: 100%;
            background: linear-gradient(90deg, #e94560, #ffc107, #4ecca3);
            transition: width 0.5s ease;
        }
        .soc-marker {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
        }
        .soc-marker.reserve { background: #e94560; }
        .soc-marker.cutoff { background: #ffc107; }
        .soc-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 6px;
            font-size: 0.65rem;
        }
        .soc-legend span { display: flex; align-items: center; gap: 4px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
        .legend-dot.reserve { background: #e94560; }
        .legend-dot.cutoff { background: #ffc107; }
        .legend-dot.current { background: #4ecca3; }

        /* TOU Table */
        .tou-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .tou-table th, .tou-table td { padding: 6px 10px; text-align: left; border-bottom: 1px solid #2a3f5f; }
        .tou-table th { color: #888; font-weight: normal; font-size: 0.7rem; }
        .tou-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
        }
        .tou-status.on { background: rgba(78, 204, 163, 0.2); color: #4ecca3; }
        .tou-status.off { background: rgba(233, 69, 96, 0.2); color: #e94560; }
        .tou-target { background: rgba(78, 204, 163, 0.1); }
        .tou-target td:first-child { color: #4ecca3; font-weight: 600; }
        .tou-free-energy { background: rgba(52, 152, 219, 0.1); }
        .tou-free-energy td:first-child { color: #3498db; font-weight: 600; }
        .tou-legend { font-size: 0.65rem; color: #888; margin-top: 8px; text-align: right; }

        /* Settings */
        .settings-top-row {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 12px;
            margin-bottom: 12px;
        }
        .settings-inputs {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: stretch;
        }
        .settings-group {
            background: #1a1a2e;
            padding: 10px 12px;
            border-radius: 6px;
        }
        .settings-group-label {
            font-size: 0.65rem;
            color: #4ecca3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .settings-inline {
            display: flex;
            gap: 10px;
        }
        .setting-item { min-width: 70px; }
        .setting-item label { display: block; font-size: 0.65rem; color: #888; margin-bottom: 3px; }
        .setting-item input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #2a3f5f;
            border-radius: 4px;
            background: #0d1321;
            color: #eee;
            font-size: 0.85rem;
        }
        .setting-item input:focus { outline: none; border-color: #4ecca3; }
        /* Schedule Settings Grid */
        .schedule-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 600px) {
            .schedule-grid { grid-template-columns: 1fr; }
        }
        .schedule-section {
            background: #1a1a2e;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }
        .schedule-section-title {
            font-size: 0.8rem;
            color: #4ecca3;
            margin-bottom: 10px;
            font-weight: 500;
        }
        .schedule-form { display: flex; flex-direction: column; gap: 8px; flex: 1; justify-content: space-between; }
        .schedule-row {
            display: flex;
            gap: 8px;
        }
        .schedule-row .setting-item { flex: 1; min-width: 60px; }
        .schedule-row .setting-item input { padding: 5px 6px; font-size: 0.8rem; }
        .scheduler-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #2a3f5f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .scheduler-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .scheduler-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }
        .scheduler-status { font-size: 0.9rem; font-weight: bold; white-space: nowrap; }
        .scheduler-status.running { color: #4ecca3; }
        .scheduler-status.stopped { color: #e94560; }
        .scheduler-buttons { display: flex; gap: 6px; }
        .btn-sm { padding: 5px 10px; font-size: 0.7rem; }
        .btn-save {
            margin-top: 12px;
            width: 100%;
        }
        @media (max-width: 600px) {
            .settings-top-row {
                flex-direction: column;
            }
            .settings-inputs {
                width: 100%;
            }
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .weather-day {
                padding: 8px 4px;
            }
            .weather-day .weather-icon {
                font-size: 1.2rem;
            }
            .weather-day .day-name {
                font-size: 0.6rem;
            }
            .weather-day .day-date {
                font-size: 0.55rem;
            }
            .weather-day .condition {
                font-size: 0.55rem;
            }
            .weather-day .temp {
                font-size: 0.65rem;
            }
            .weather-day .clouds,
            .weather-day .pop {
                font-size: 0.5rem;
            }
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #4ecca3; color: #1a1a2e; }
        .btn-primary:hover { background: #3db892; }
        .btn-danger { background: #e94560; color: #fff; }
        .btn-danger:hover { background: #d13654; }
        .btn-full { width: 100%; margin-top: 10px; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: #fff;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #4ecca3; }
        .toast.error { background: #e94560; }

        .refresh-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }
        .refresh-indicator.active { background: #4ecca3; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .error-msg { color: #e94560; font-size: 0.8rem; margin-top: 8px; }
        .status-footer { display: flex; justify-content: space-between; font-size: 0.7rem; color: #555; margin-top: 10px; }

        /* Weather Forecast */
        .weather-container {
            display: flex;
            gap: 8px;
            padding: 8px 0;
        }
        .weather-day {
            flex: 1 1 0;
            min-width: 0;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 10px 6px;
            text-align: center;
            border: 2px solid transparent;
        }
        .weather-day.today {
            border-color: #4ecca3;
        }
        .weather-day.bad-weather {
            background: rgba(233, 69, 96, 0.15);
            border-color: #e94560;
        }
        .weather-day .day-name {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 4px;
        }
        .weather-day .day-date {
            font-size: 0.65rem;
            color: #666;
            margin-bottom: 6px;
        }
        .weather-day .weather-icon {
            font-size: 1.5rem;
            margin: 4px 0;
        }
        .weather-day .condition {
            font-size: 0.65rem;
            color: #aaa;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .weather-day .temp {
            font-size: 0.75rem;
            color: #4ecca3;
        }
        .weather-day .clouds {
            font-size: 0.6rem;
            color: #888;
            margin-top: 2px;
        }
        .weather-day .pop {
            font-size: 0.6rem;
            color: #3498db;
        }
        .weather-skip-banner {
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid #e94560;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .weather-skip-banner.inactive {
            background: rgba(78, 204, 163, 0.1);
            border-color: #4ecca3;
        }
        .weather-skip-icon {
            font-size: 1.2rem;
        }
        .weather-skip-text {
            flex: 1;
            font-size: 0.8rem;
        }
        .weather-skip-text .title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        .weather-skip-text .reason {
            color: #aaa;
            font-size: 0.7rem;
        }
        .weather-disabled {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 0.85rem;
        }
        .weather-disabled a {
            color: #4ecca3;
            text-decoration: none;
        }
        .city-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #0d1321;
            border: 1px solid #2a3f5f;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        .city-dropdown.show { display: block; }
        .city-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            border-bottom: 1px solid #2a3f5f;
        }
        .city-option:hover { background: #1a1a2e; }
        .city-option:last-child { border-bottom: none; }
        .solar-estimate { font-size: 0.6rem; color: #ffc107; margin-top: 2px; }
        .weather-settings-toggle {
            float: right;
            font-size: 0.7rem;
            color: #4ecca3;
            cursor: pointer;
            padding: 2px 6px;
            border: 1px solid #4ecca3;
            border-radius: 4px;
        }
        .weather-settings-toggle:hover {
            background: rgba(78, 204, 163, 0.1);
        }
        .weather-settings {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #2a3f5f;
        }
        .weather-settings.show {
            display: block;
        }
        .weather-settings-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        /* Setup Modal */
        .setup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .setup-modal {
            background: #16213e;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .setup-modal h2 {
            margin: 0 0 20px 0;
            color: #4ecca3;
        }
        .setup-step { display: none; }
        .setup-step.active { display: block; }
        .setup-field { margin-bottom: 15px; }
        .setup-field label {
            display: block;
            margin-bottom: 5px;
            color: #8892b0;
            font-size: 0.9rem;
        }
        .setup-field input, .setup-field select {
            width: 100%;
            padding: 10px;
            border: 1px solid #2a3f5f;
            border-radius: 4px;
            background: #0d1321;
            color: #e6e6e6;
            font-size: 1rem;
        }
        .setup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .setup-buttons .btn { flex: 1; }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .test-result.success { background: rgba(78, 204, 163, 0.2); color: #4ecca3; }
        .test-result.error { background: rgba(255, 82, 82, 0.2); color: #ff5252; }
        .setup-progress {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #2a3f5f;
        }
        .progress-dot.active { background: #4ecca3; }
        .progress-dot.completed { background: #4ecca3; }
    </style>
</head>
<body>
    <!-- Setup Modal -->
    <div class="setup-overlay" id="setupOverlay" style="display: none;">
        <div class="setup-modal">
            <div class="setup-progress">
                <div class="progress-dot active" id="dot1"></div>
                <div class="progress-dot" id="dot2"></div>
                <div class="progress-dot" id="dot3"></div>
            </div>

            <!-- Step 1: Deye API -->
            <div class="setup-step active" id="setupStep1">
                <h2>Deye Cloud Setup</h2>
                <p style="color: #8892b0; margin-bottom: 20px;">Enter your Deye Cloud API credentials from the Deye Developer Portal.</p>

                <div class="setup-field">
                    <label>API Base URL</label>
                    <select id="setupApiUrl">
                        <option value="https://eu1-developer.deyecloud.com">EU (eu1-developer.deyecloud.com)</option>
                        <option value="https://us1-developer.deyecloud.com">US (us1-developer.deyecloud.com)</option>
                        <option value="https://as1-developer.deyecloud.com">Asia (as1-developer.deyecloud.com)</option>
                    </select>
                </div>
                <div class="setup-field">
                    <label>App ID</label>
                    <input type="text" id="setupAppId" placeholder="Your App ID">
                </div>
                <div class="setup-field">
                    <label>App Secret</label>
                    <input type="password" id="setupAppSecret" placeholder="Your App Secret">
                </div>
                <div class="setup-field">
                    <label>Email</label>
                    <input type="email" id="setupEmail" placeholder="Your Deye account email">
                </div>
                <div class="setup-field">
                    <label>Password</label>
                    <input type="password" id="setupPassword" placeholder="Your Deye account password">
                </div>
                <div class="setup-field">
                    <label>Device Serial Number</label>
                    <input type="text" id="setupDeviceSn" placeholder="Your inverter serial number">
                </div>

                <div id="deyeTestResult" class="test-result" style="display: none;"></div>

                <div class="setup-buttons">
                    <button type="button" class="btn btn-secondary" onclick="testDeyeConnection()">Test Connection</button>
                    <button type="button" class="btn btn-primary" onclick="goToStep(2)">Next</button>
                </div>
            </div>

            <!-- Step 2: Location (Optional) -->
            <div class="setup-step" id="setupStep2">
                <h2>Location Setup (Optional)</h2>
                <p style="color: #8892b0; margin-bottom: 20px;">Set your location to enable weather-based discharge skipping and solar forecasts. No API key required!</p>

                <div class="setup-field" style="position: relative;">
                    <label>Search Your Location</label>
                    <input type="text" id="setupCitySearch" placeholder="Type city name (e.g. Sydney)..." autocomplete="off">
                    <input type="hidden" id="setupCityName">
                    <input type="hidden" id="setupLatitude">
                    <input type="hidden" id="setupLongitude">
                    <input type="hidden" id="setupTimezone">
                    <div id="setupCityDropdown" class="city-dropdown"></div>
                </div>

                <div id="weatherTestResult" class="test-result" style="display: none;"></div>

                <div class="setup-buttons">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Back</button>
                    <button type="button" class="btn btn-primary" id="setupWeatherNextBtn" onclick="goToStep(3)">Skip</button>
                </div>
            </div>

            <!-- Step 3: Solar Capacity -->
            <div class="setup-step" id="setupStep3">
                <h2>Solar System Details (Optional)</h2>
                <p style="color: #8892b0; margin-bottom: 20px;">Enter your system capacity for accurate solar forecasts. Panel tilt and direction are automatically calculated from your location.</p>

                <div class="setup-field">
                    <label>Inverter Capacity (kW)</label>
                    <input type="number" id="setupInverterCapacity" placeholder="e.g. 5 for a 5kW inverter" min="0" step="0.1">
                    <small style="color: #666;">Your inverter's rated power (e.g. 5, 8, 10)</small>
                </div>

                <div class="setup-field">
                    <label>Panel Capacity (kWp)</label>
                    <input type="number" id="setupPanelCapacity" placeholder="Leave blank to auto-estimate" min="0" step="0.1">
                    <small style="color: #666;">Optional - if not set, estimated as inverter capacity Ã— 1.25</small>
                </div>

                <div class="setup-buttons">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(2)">Back</button>
                    <button type="button" class="btn btn-primary" onclick="completeSetup()">Complete Setup</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Deye Force Discharger <span class="refresh-indicator" id="refreshIndicator"></span></h1>

        <!-- System Status -->
        <div class="card">
            <h2>System Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="label">Force Discharge</div>
                    <div class="value" id="forceDischargeStatus">--</div>
                </div>
                <div class="status-item">
                    <div class="label">In Window</div>
                    <div class="value" id="inWindow">--</div>
                </div>
                <div class="status-item" id="weatherSkipItem" style="display: none;">
                    <div class="label">Weather Skip</div>
                    <div class="value" id="weatherSkipStatus">--</div>
                </div>
                <div class="status-item" id="freeEnergyItem" style="display: none;">
                    <div class="label">Free Energy</div>
                    <div class="value" id="freeEnergyStatus">--</div>
                </div>
                <div class="status-item free-energy-charge" id="freeEnergyChargeItem" style="display: none;">
                    <div class="label">Free Charge</div>
                    <div class="value" id="freeEnergyChargeStatus">--</div>
                    <div class="sub-label" id="freeEnergyChargeDetail"></div>
                </div>
            </div>

            <!-- Power Gauge -->
            <div class="gauge-section">
                <div class="gauge-header">
                    <span class="gauge-label">Battery Power</span>
                    <span class="gauge-value" id="powerDirection">--</span>
                </div>
                <div class="power-gauge-container">
                    <div class="power-gauge">
                        <div class="power-gauge-fill" id="powerGaugeFill" style="width: 0%"></div>
                        <div class="power-gauge-label" id="powerGaugeLabel">0 W</div>
                    </div>
                    <div class="power-info">
                        <div class="power-value" id="powerValue">-- kW</div>
                        <div class="power-max">/ <span id="maxPowerDisplay">10</span> kW max</div>
                    </div>
                </div>
            </div>

            <!-- SoC Bar -->
            <div class="gauge-section">
                <div class="gauge-header">
                    <span class="gauge-label">State of Charge</span>
                    <span class="gauge-value" id="socValue">-- %</span>
                </div>
                <div class="soc-bar">
                    <div class="soc-fill" id="socBar" style="width: 0%"></div>
                    <div class="soc-marker reserve" id="reserveMarker" style="left: 20%"></div>
                    <div class="soc-marker cutoff" id="cutoffMarker" style="left: 50%"></div>
                </div>
                <div class="soc-legend">
                    <span><div class="legend-dot reserve"></div> Reserve <span id="reserveLabel">20%</span></span>
                    <span><div class="legend-dot cutoff"></div> Cutoff <span id="cutoffLabel">50%</span></span>
                    <span><div class="legend-dot current"></div> Current</span>
                </div>
            </div>
            <div id="errorMsg" class="error-msg" style="display: none;"></div>

            <!-- Scheduler Controls -->
            <div class="scheduler-section">
                <div class="scheduler-header">
                    <span class="scheduler-label">Scheduler</span>
                    <span class="scheduler-status" id="schedulerStatusLarge">STOPPED</span>
                </div>
                <div class="scheduler-buttons">
                    <button type="button" class="btn btn-sm btn-primary" id="startBtn" onclick="startScheduler()">Start</button>
                    <button type="button" class="btn btn-sm btn-danger" id="stopBtn" onclick="stopScheduler()">Stop</button>
                </div>
            </div>
        </div>

        <!-- TOU Settings -->
        <div class="card">
            <h2>Inverter TOU Settings</h2>
            <table class="tou-table">
                <thead>
                    <tr>
                        <th>Time Range</th>
                        <th>SoC</th>
                        <th>Power</th>
                        <th>Grid</th>
                    </tr>
                </thead>
                <tbody id="touTableBody">
                    <tr><td colspan="4" style="text-align: center; color: #888;">Loading...</td></tr>
                </tbody>
            </table>
            <div class="tou-legend">ðŸ’° Force discharge &nbsp; âš¡ Free energy</div>
        </div>

        <!-- Weather Forecast -->
        <div class="card" id="weatherCard">
            <h2>
                Weather Forecast
                <span class="weather-settings-toggle" onclick="toggleWeatherSettings()">Settings</span>
            </h2>
            <div id="weatherContent">
                <div class="weather-disabled">Loading weather data...</div>
            </div>
            <div class="weather-settings" id="weatherSettings">
                <form id="weatherSettingsForm">
                    <div class="weather-settings-row">
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="weatherEnabled"> Enable Weather Check
                            </label>
                        </div>
                    </div>
                    <div class="weather-settings-row">
                        <div class="setting-item" style="flex: 2; position: relative;">
                            <label>Location</label>
                            <input type="text" id="weatherCity" placeholder="Type 2+ chars to search..." autocomplete="off">
                            <input type="hidden" id="weatherCityName">
                            <input type="hidden" id="weatherLatitude">
                            <input type="hidden" id="weatherLongitude">
                            <input type="hidden" id="weatherTimezone">
                            <div id="cityDropdown" class="city-dropdown"></div>
                        </div>
                        <div class="setting-item">
                            <label>Min Solar Threshold (kWh)</label>
                            <input type="number" id="weatherSolarThreshold" min="0" max="100" step="1" value="15">
                            <small style="color: #666; font-size: 0.8em;">Skip discharge if tomorrow's forecast is below this</small>
                        </div>
                    </div>
                    <div class="weather-settings-row">
                        <div class="setting-item">
                            <label>Inverter Capacity (kW)</label>
                            <input type="number" id="weatherInverterCapacity" min="0" max="100" step="0.1" value="0" placeholder="e.g. 5">
                            <small style="color: #666; font-size: 0.8em;">Your inverter's rated power</small>
                        </div>
                        <div class="setting-item">
                            <label>Panel Capacity (kWp)</label>
                            <input type="number" id="weatherPanelCapacity" min="0" max="100" step="0.1" value="0" placeholder="Optional - auto from inverter">
                            <small style="color: #666; font-size: 0.8em;">Leave blank to auto-estimate (inverter Ã— 1.25)</small>
                        </div>
                    </div>
                    <div class="weather-settings-row">
                        <div class="setting-item">
                            <label>Panel Tilt (Â°)</label>
                            <input type="number" id="weatherPanelTilt" min="0" max="90" step="1" value="" placeholder="Default: 25">
                            <small style="color: #666; font-size: 0.8em;">Roof angle (0=flat, 90=vertical)</small>
                        </div>
                        <div class="setting-item">
                            <label>Panel Azimuth (Â°)</label>
                            <input type="number" id="weatherPanelAzimuth" min="-180" max="180" step="1" value="" placeholder="Auto from location">
                            <small style="color: #666; font-size: 0.8em;">Direction: 0=North, 90=East, 180=South, -90=West</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">Save Weather Settings</button>
                </form>
            </div>
        </div>

        <!-- Schedule Settings -->
        <div class="card">
            <h2>Schedule Settings</h2>
            <div class="schedule-grid">
                <!-- Force Discharge Window -->
                <div class="schedule-section">
                    <div class="schedule-section-title">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" id="forceDischargeEnabled" checked>
                            ðŸ’° Force Discharge
                        </label>
                    </div>
                    <form id="scheduleForm" class="schedule-form">
                        <div class="schedule-row">
                            <div class="setting-item">
                                <label>Start</label>
                                <input type="time" id="startTime" value="17:30">
                            </div>
                            <div class="setting-item">
                                <label>End</label>
                                <input type="time" id="endTime" value="19:30">
                            </div>
                        </div>
                        <div class="schedule-row">
                            <div class="setting-item">
                                <label>Normal SoC %</label>
                                <input type="number" id="minSocReserve" min="5" max="100" value="20" title="Outside discharge window - battery reserve for normal use">
                            </div>
                            <div class="setting-item">
                                <label>Discharge SoC %</label>
                                <input type="number" id="cutoffSoc" min="5" max="100" value="50" title="During discharge window - stop when battery reaches this level">
                            </div>
                            <div class="setting-item">
                                <label>Reactivation %</label>
                                <input type="number" id="reactivationMargin" min="0" max="20" value="5" title="Buffer above cutoff to restart discharge - prevents cycling">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">Save</button>
                    </form>
                </div>
                <!-- Free Energy Window -->
                <div class="schedule-section" id="freeEnergyCard">
                    <div class="schedule-section-title">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" id="freeEnergyEnabled">
                            âš¡ Free Energy Charge
                        </label>
                    </div>
                    <form id="freeEnergySettingsForm" class="schedule-form">
                        <div class="schedule-row">
                            <div class="setting-item">
                                <label>Start</label>
                                <input type="time" id="freeEnergyStart" value="11:00">
                            </div>
                            <div class="setting-item">
                                <label>End</label>
                                <input type="time" id="freeEnergyEnd" value="14:00">
                            </div>
                            <div class="setting-item">
                                <label>Target SoC</label>
                                <input type="number" id="freeEnergyTargetSoc" min="50" max="100" value="100">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">Save</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Status Footer -->
        <div class="status-footer">
            <span>Last: <span id="lastCheck">--</span></span>
            <span>Server: <span id="serverTime">--</span></span>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let refreshInterval;
        let maxPower = 10000;
        let isEditingSettings = false;

        // Setup wizard functions
        async function checkSetupStatus() {
            try {
                const response = await fetch('/api/setup/status');
                const data = await response.json();
                if (data.needs_setup) {
                    document.getElementById('setupOverlay').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error checking setup status:', error);
            }
        }

        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.setup-step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.progress-dot').forEach(d => d.classList.remove('active', 'completed'));

            // Show target step
            document.getElementById(`setupStep${step}`).classList.add('active');

            // Update progress dots
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById(`dot${i}`);
                if (i < step) {
                    dot.classList.add('completed');
                } else if (i === step) {
                    dot.classList.add('active');
                }
            }
        }

        async function testDeyeConnection() {
            const resultEl = document.getElementById('deyeTestResult');
            resultEl.style.display = 'block';
            resultEl.className = 'test-result';
            resultEl.textContent = 'Testing connection...';

            const payload = {
                api_base_url: document.getElementById('setupApiUrl').value,
                app_id: document.getElementById('setupAppId').value,
                app_secret: document.getElementById('setupAppSecret').value,
                email: document.getElementById('setupEmail').value,
                password: document.getElementById('setupPassword').value,
                device_sn: document.getElementById('setupDeviceSn').value
            };

            try {
                const response = await fetch('/api/setup/test-deye', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (data.success) {
                    resultEl.className = 'test-result success';
                    resultEl.textContent = `Connected! Device: ${data.device_name || 'Found'}`;
                } else {
                    resultEl.className = 'test-result error';
                    resultEl.textContent = `Error: ${data.error}`;
                }
            } catch (error) {
                resultEl.className = 'test-result error';
                resultEl.textContent = `Connection failed: ${error.message}`;
            }
        }

        // Setup wizard city search (no API key required - uses Open-Meteo)
        let setupCitySearchTimeout;

        // Initialize setup city search on page load
        (function initSetupCitySearch() {
            const input = document.getElementById('setupCitySearch');
            const dropdown = document.getElementById('setupCityDropdown');
            const resultEl = document.getElementById('weatherTestResult');
            const nextBtn = document.getElementById('setupWeatherNextBtn');

            input.addEventListener('input', async (e) => {
                clearTimeout(setupCitySearchTimeout);
                const query = e.target.value.trim();

                if (query.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }

                setupCitySearchTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`/api/setup/search-cities?q=${encodeURIComponent(query)}`);
                        const data = await response.json();

                        if (data.success && data.cities.length > 0) {
                            dropdown.innerHTML = data.cities.map(city =>
                                `<div class="city-option" data-name="${city.display_name}" data-lat="${city.lat}" data-lon="${city.lon}" data-tz="${city.timezone || 'auto'}">${city.display_name}</div>`
                            ).join('');
                            dropdown.classList.add('show');
                        } else {
                            dropdown.classList.remove('show');
                        }
                    } catch (error) {
                        console.error('City search error:', error);
                        dropdown.classList.remove('show');
                    }
                }, 300);
            });

            dropdown.addEventListener('click', (e) => {
                if (e.target.classList.contains('city-option')) {
                    const cityName = e.target.dataset.name;
                    const lat = e.target.dataset.lat;
                    const lon = e.target.dataset.lon;
                    const tz = e.target.dataset.tz;

                    document.getElementById('setupCitySearch').value = cityName;
                    document.getElementById('setupCityName').value = cityName;
                    document.getElementById('setupLatitude').value = lat;
                    document.getElementById('setupLongitude').value = lon;
                    document.getElementById('setupTimezone').value = tz;
                    dropdown.classList.remove('show');

                    // Show success and enable next
                    resultEl.style.display = 'block';
                    resultEl.className = 'test-result success';
                    resultEl.textContent = `Location set: ${cityName}`;
                    nextBtn.textContent = 'Next';
                }
            });
        })();

        async function completeSetup() {
            const lat = document.getElementById('setupLatitude').value;
            const lon = document.getElementById('setupLongitude').value;

            const payload = {
                deye: {
                    api_base_url: document.getElementById('setupApiUrl').value,
                    app_id: document.getElementById('setupAppId').value,
                    app_secret: document.getElementById('setupAppSecret').value,
                    email: document.getElementById('setupEmail').value,
                    password: document.getElementById('setupPassword').value,
                    device_sn: document.getElementById('setupDeviceSn').value
                },
                weather: {
                    city_name: document.getElementById('setupCityName').value || '',
                    latitude: lat ? parseFloat(lat) : null,
                    longitude: lon ? parseFloat(lon) : null,
                    timezone: document.getElementById('setupTimezone').value || 'auto'
                },
                solar: {
                    inverter_capacity_kw: parseFloat(document.getElementById('setupInverterCapacity').value) || 0,
                    panel_capacity_kw: parseFloat(document.getElementById('setupPanelCapacity').value) || 0
                }
            };

            try {
                const response = await fetch('/api/setup/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('setupOverlay').style.display = 'none';
                    showToast('Setup complete!');
                    refreshStatus();
                    refreshWeather();
                } else {
                    showToast(`Setup failed: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast(`Setup failed: ${error.message}`, 'error');
            }
        }

        // Check setup status on page load
        checkSetupStatus();

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }

        function formatTime(isoString) {
            if (!isoString) return '--';
            return new Date(isoString).toLocaleTimeString();
        }

        function updatePowerGauge(power) {
            const gauge = document.getElementById('powerGaugeFill');
            const label = document.getElementById('powerGaugeLabel');
            const value = document.getElementById('powerValue');
            const directionEl = document.getElementById('powerDirection');

            if (power === null || power === undefined) {
                gauge.style.width = '0%';
                label.textContent = '-- W';
                value.textContent = '-- kW';
                directionEl.textContent = '--';
                directionEl.style.color = '#888';
                return;
            }

            const absPower = Math.abs(power);
            const percent = Math.min((absPower / maxPower) * 100, 100);
            const isCharging = power < 0;
            const isDischarging = power > 0;

            gauge.style.width = `${percent}%`;

            if (isDischarging) {
                // Discharging: orange/amber gradient - power going OUT
                gauge.style.background = 'linear-gradient(90deg, #ff9800, #f44336)';
                label.textContent = `â†“ ${Math.round(absPower)} W`;
                label.style.color = '#fff';
                value.textContent = `${(absPower / 1000).toFixed(2)} kW`;
                value.style.color = '#ff9800';
                directionEl.textContent = 'â†“ DISCHARGING';
                directionEl.style.color = '#ff9800';
            } else if (isCharging) {
                // Charging: green/blue gradient - power coming IN
                gauge.style.background = 'linear-gradient(90deg, #4ecca3, #3498db)';
                label.textContent = `â†‘ ${Math.round(absPower)} W`;
                label.style.color = '#fff';
                value.textContent = `${(absPower / 1000).toFixed(2)} kW`;
                value.style.color = '#4ecca3';
                directionEl.textContent = 'â†‘ CHARGING';
                directionEl.style.color = '#4ecca3';
            } else {
                gauge.style.background = '#2a3f5f';
                label.textContent = '0 W';
                label.style.color = '#888';
                value.textContent = '0 kW';
                value.style.color = '#888';
                directionEl.textContent = 'IDLE';
                directionEl.style.color = '#888';
            }
        }

        function updateTouTable(touSettings, windowStart, freeEnergy) {
            const tbody = document.getElementById('touTableBody');

            if (!touSettings) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888;">Unable to fetch</td></tr>';
                return;
            }

            const items = touSettings.timeUseSettingItems || [];
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888;">No schedules</td></tr>';
                return;
            }

            const sortedItems = [...items].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            // Normalize window start for comparison (remove colon)
            const windowStartNorm = windowStart.replace(':', '');
            const freeEnergyStartNorm = freeEnergy && freeEnergy.enabled ? (freeEnergy.start_time || '').replace(':', '') : '';

            tbody.innerHTML = sortedItems.map((item, index) => {
                const startTime = item.time || '--';
                const nextIndex = (index + 1) % sortedItems.length;
                const endTime = sortedItems[nextIndex].time || '--';

                // Check if this is force discharge window
                const isDischargeWindow = startTime.replace(':', '') === windowStartNorm;
                // Check if this is free energy window
                const isFreeEnergyWindow = freeEnergyStartNorm && startTime.replace(':', '') === freeEnergyStartNorm;

                let timeDisplay = `${startTime} - ${endTime}`;
                let rowClass = '';
                if (isDischargeWindow) {
                    timeDisplay = `ðŸ’° ${startTime} - ${endTime}`;
                    rowClass = 'tou-target';
                } else if (isFreeEnergyWindow) {
                    timeDisplay = `âš¡ ${startTime} - ${endTime}`;
                    rowClass = 'tou-free-energy';
                }

                return `
                    <tr class="${rowClass}">
                        <td>${timeDisplay}</td>
                        <td>${item.soc !== undefined ? item.soc + '%' : '--'}</td>
                        <td>${item.power || '--'}</td>
                        <td><span class="tou-status ${item.enableGridCharge ? 'on' : 'off'}">${item.enableGridCharge ? 'ON' : 'OFF'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateSchedulerButtons(isRunning) {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const status = document.getElementById('schedulerStatusLarge');

            status.textContent = isRunning ? 'RUNNING' : 'STOPPED';
            status.className = `scheduler-status ${isRunning ? 'running' : 'stopped'}`;
            startBtn.disabled = isRunning;
            stopBtn.disabled = !isRunning;
            startBtn.style.opacity = isRunning ? '0.5' : '1';
            stopBtn.style.opacity = isRunning ? '1' : '0.5';
        }

        async function refreshStatus() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.className = 'refresh-indicator active';

            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                const state = data.current_state;
                const schedule = data.schedule;

                // Update max power from inverter capacity
                maxPower = state.inverter_capacity || 10000;
                document.getElementById('maxPowerDisplay').textContent = (maxPower / 1000).toFixed(0);

                // SoC
                const socText = state.soc !== null ? `${state.soc}%` : '--%';
                document.getElementById('socValue').textContent = socText;
                document.getElementById('socBar').style.width = state.soc !== null ? `${state.soc}%` : '0%';

                // Power gauge
                updatePowerGauge(state.battery_power);

                // Status
                const forceStatus = document.getElementById('forceDischargeStatus');
                forceStatus.textContent = state.force_discharge_active ? 'ACTIVE' : 'INACTIVE';
                forceStatus.className = `value ${state.force_discharge_active ? 'active' : 'inactive'}`;

                const inWindow = document.getElementById('inWindow');
                inWindow.textContent = data.in_discharge_window ? 'YES' : 'NO';
                inWindow.className = `value ${data.in_discharge_window ? 'active' : 'inactive'}`;

                // Weather skip status
                const weatherSkipItem = document.getElementById('weatherSkipItem');
                const weatherSkipStatus = document.getElementById('weatherSkipStatus');
                if (data.weather && data.weather.enabled) {
                    weatherSkipItem.style.display = 'block';
                    if (data.weather.skip_active) {
                        weatherSkipStatus.textContent = 'ACTIVE';
                        weatherSkipStatus.className = 'value inactive';
                    } else {
                        weatherSkipStatus.textContent = 'OFF';
                        weatherSkipStatus.className = 'value active';
                    }
                } else {
                    weatherSkipItem.style.display = 'none';
                }

                // Free energy status
                const freeEnergyItem = document.getElementById('freeEnergyItem');
                const freeEnergyStatusEl = document.getElementById('freeEnergyStatus');
                const freeEnergyChargeItem = document.getElementById('freeEnergyChargeItem');
                const freeEnergyChargeStatus = document.getElementById('freeEnergyChargeStatus');
                const freeEnergyChargeDetail = document.getElementById('freeEnergyChargeDetail');

                if (data.free_energy && data.free_energy.enabled) {
                    freeEnergyItem.style.display = 'block';
                    freeEnergyChargeItem.style.display = 'block';

                    const targetSoc = data.free_energy.target_soc || 100;
                    const currentSoc = state.soc || 0;
                    const batteryPower = state.battery_power || 0;
                    const isCharging = batteryPower < 0;

                    if (data.in_free_energy_window) {
                        freeEnergyStatusEl.textContent = 'ACTIVE';
                        freeEnergyStatusEl.className = 'value active';

                        if (currentSoc >= targetSoc) {
                            freeEnergyChargeStatus.textContent = 'COMPLETE';
                            freeEnergyChargeStatus.className = 'value active';
                            freeEnergyChargeDetail.textContent = `${currentSoc}% / ${targetSoc}%`;
                        } else if (isCharging) {
                            freeEnergyChargeStatus.textContent = 'CHARGING';
                            freeEnergyChargeStatus.className = 'value charging';
                            freeEnergyChargeDetail.textContent = `${currentSoc}% â†’ ${targetSoc}%`;
                        } else {
                            freeEnergyChargeStatus.textContent = 'WAITING';
                            freeEnergyChargeStatus.className = 'value inactive';
                            freeEnergyChargeDetail.textContent = `${currentSoc}% / ${targetSoc}%`;
                        }
                    } else {
                        freeEnergyStatusEl.textContent = 'OFF';
                        freeEnergyStatusEl.className = 'value inactive';
                        freeEnergyChargeStatus.textContent = 'SCHEDULED';
                        freeEnergyChargeStatus.className = 'value';
                        freeEnergyChargeDetail.textContent = `${data.free_energy.start_time} - ${data.free_energy.end_time}`;
                    }
                } else {
                    freeEnergyItem.style.display = 'none';
                    freeEnergyChargeItem.style.display = 'block';
                    freeEnergyChargeStatus.textContent = 'DISABLED';
                    freeEnergyChargeStatus.className = 'value';
                    freeEnergyChargeDetail.textContent = '';
                }

                updateSchedulerButtons(state.scheduler_status === 'running');

                // SoC markers
                const reserve = schedule.min_soc_reserve || 20;
                const cutoff = schedule.force_discharge_cutoff_soc || 50;
                document.getElementById('reserveMarker').style.left = `${reserve}%`;
                document.getElementById('cutoffMarker').style.left = `${cutoff}%`;
                document.getElementById('reserveLabel').textContent = `${reserve}%`;
                document.getElementById('cutoffLabel').textContent = `${cutoff}%`;

                // Times
                document.getElementById('lastCheck').textContent = formatTime(state.last_check);
                document.getElementById('serverTime').textContent = formatTime(data.server_time);

                // Error
                const errorMsg = document.getElementById('errorMsg');
                if (state.last_error) {
                    errorMsg.textContent = `Error: ${state.last_error}`;
                    errorMsg.style.display = 'block';
                } else {
                    errorMsg.style.display = 'none';
                }

                // Update form only if user is not actively editing
                if (!isEditingSettings) {
                    document.getElementById('forceDischargeEnabled').checked = schedule.enabled !== false;
                    document.getElementById('startTime').value = schedule.force_discharge_start || '17:30';
                    document.getElementById('endTime').value = schedule.force_discharge_end || '19:30';
                    document.getElementById('minSocReserve').value = schedule.min_soc_reserve || 20;
                    document.getElementById('cutoffSoc').value = schedule.force_discharge_cutoff_soc || 50;
                    document.getElementById('reactivationMargin').value = schedule.reactivation_margin || 5;
                }

                // TOU table
                updateTouTable(data.tou_settings, schedule.force_discharge_start || '17:30', data.free_energy);

            } catch (error) {
                console.error('Error:', error);
            }

            indicator.className = 'refresh-indicator';
        }

        async function startScheduler() {
            try {
                const response = await fetch('/api/scheduler/start', { method: 'POST' });
                const data = await response.json();
                showToast(data.message);
                refreshStatus();
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        async function stopScheduler() {
            try {
                const response = await fetch('/api/scheduler/stop', { method: 'POST' });
                const data = await response.json();
                showToast(data.message);
                refreshStatus();
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const schedule = {
                enabled: document.getElementById('forceDischargeEnabled').checked,
                force_discharge_start: document.getElementById('startTime').value,
                force_discharge_end: document.getElementById('endTime').value,
                min_soc_reserve: parseInt(document.getElementById('minSocReserve').value),
                force_discharge_cutoff_soc: parseInt(document.getElementById('cutoffSoc').value),
                reactivation_margin: parseInt(document.getElementById('reactivationMargin').value) || 5
            };

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedule, update_tou: true })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('Settings saved');
                    refreshStatus();
                } else {
                    showToast(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        });

        // Track when user is editing settings to prevent refresh from overwriting
        const settingsForm = document.getElementById('scheduleForm');
        settingsForm.querySelectorAll('input').forEach(input => {
            input.addEventListener('focus', () => { isEditingSettings = true; });
            input.addEventListener('blur', () => { isEditingSettings = false; });
        });

        refreshStatus();
        refreshInterval = setInterval(refreshStatus, 10000);

        // Weather functionality
        let weatherData = null;

        function getWeatherIcon(condition, icon) {
            const iconMap = {
                'Clear': 'â˜€ï¸',
                'Clouds': 'â˜ï¸',
                'Rain': 'ðŸŒ§ï¸',
                'Drizzle': 'ðŸŒ¦ï¸',
                'Thunderstorm': 'â›ˆï¸',
                'Snow': 'â„ï¸',
                'Mist': 'ðŸŒ«ï¸',
                'Fog': 'ðŸŒ«ï¸',
                'Haze': 'ðŸŒ«ï¸'
            };
            return iconMap[condition] || 'ðŸŒ¤ï¸';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function renderWeatherForecast(data) {
            const container = document.getElementById('weatherContent');

            if (!data.enabled) {
                container.innerHTML = `
                    <div class="weather-disabled">
                        Weather feature is disabled.<br>
                        <small>Enable in Settings to skip discharge during bad weather.</small>
                    </div>
                `;
                return;
            }

            if (!data.success || !data.forecast) {
                container.innerHTML = `
                    <div class="weather-disabled">
                        ${data.error || 'Unable to fetch weather data'}<br>
                        <small>Check API key and location settings.</small>
                    </div>
                `;
                return;
            }

            const forecast = data.forecast;
            const daily = forecast.daily || [];

            // Skip status banner
            let bannerHtml = '';
            if (data.skip_discharge) {
                bannerHtml = `
                    <div class="weather-skip-banner">
                        <span class="weather-skip-icon">âš ï¸</span>
                        <div class="weather-skip-text">
                            <div class="title" style="color: #e94560;">Discharge Skipped</div>
                            <div class="reason">${data.skip_reason}</div>
                        </div>
                    </div>
                `;
            } else {
                bannerHtml = `
                    <div class="weather-skip-banner inactive">
                        <span class="weather-skip-icon">âœ“</span>
                        <div class="weather-skip-text">
                            <div class="title" style="color: #4ecca3;">Discharge Allowed</div>
                            <div class="reason">${data.skip_reason}</div>
                        </div>
                    </div>
                `;
            }

            // Forecast cards - limit to 4 days for better mobile display
            let forecastHtml = '<div class="weather-container">';
            daily.slice(0, 4).forEach((day, index) => {
                const classes = ['weather-day'];
                // Only highlight future days for bad weather (not today) since discharge decision is based on future forecasts
                if (!day.is_today && day.is_bad_weather) classes.push('bad-weather');

                const dayName = day.is_today ? 'Today' : day.day_name.substring(0, 3);
                const icon = getWeatherIcon(day.condition, day.icon);
                const tempMin = day.temp_min !== null ? Math.round(day.temp_min) : '--';
                const tempMax = day.temp_max !== null ? Math.round(day.temp_max) : '--';

                const solarEstimate = day.estimated_solar_kwh ? `<div class="solar-estimate">â˜€ï¸ ~${day.estimated_solar_kwh} kWh</div>` : '';
                forecastHtml += `
                    <div class="${classes.join(' ')}">
                        <div class="day-name">${dayName}</div>
                        <div class="day-date">${formatDate(day.date)}</div>
                        <div class="weather-icon">${icon}</div>
                        <div class="condition">${day.condition}</div>
                        <div class="temp">${tempMin}Â° / ${tempMax}Â°</div>
                        <div class="clouds">â˜ï¸ ${day.clouds}%</div>
                        ${day.pop > 0 ? `<div class="pop">ðŸ’§ ${day.pop}%</div>` : ''}
                        ${solarEstimate}
                    </div>
                `;
            });
            forecastHtml += '</div>';

            container.innerHTML = bannerHtml + forecastHtml;
        }

        async function refreshWeather() {
            try {
                const response = await fetch('/api/weather');
                weatherData = await response.json();
                renderWeatherForecast(weatherData);
            } catch (error) {
                console.error('Weather fetch error:', error);
                document.getElementById('weatherContent').innerHTML = `
                    <div class="weather-disabled">Error loading weather data</div>
                `;
            }
        }

        async function loadWeatherConfig() {
            try {
                const response = await fetch('/api/weather/config');
                const config = await response.json();

                document.getElementById('weatherEnabled').checked = config.enabled;
                document.getElementById('weatherCityName').value = config.city_name || '';
                document.getElementById('weatherCity').value = config.city_name || '';
                document.getElementById('weatherLatitude').value = config.latitude || '';
                document.getElementById('weatherLongitude').value = config.longitude || '';
                document.getElementById('weatherTimezone').value = config.timezone || 'auto';
                document.getElementById('weatherSolarThreshold').value = config.min_solar_threshold_kwh || 15;
                document.getElementById('weatherInverterCapacity').value = config.inverter_capacity_kw || '';
                document.getElementById('weatherPanelCapacity').value = config.panel_capacity_kw || '';
                document.getElementById('weatherPanelTilt').value = config.panel_tilt || '';
                document.getElementById('weatherPanelAzimuth').value = config.panel_azimuth !== null ? config.panel_azimuth : '';
            } catch (error) {
                console.error('Error loading weather config:', error);
            }
        }


        // City search autocomplete (uses Open-Meteo - no API key required)
        let citySearchTimeout;
        document.getElementById('weatherCity').addEventListener('input', async (e) => {
            clearTimeout(citySearchTimeout);
            const query = e.target.value.trim();
            const dropdown = document.getElementById('cityDropdown');

            if (query.length < 2) {
                dropdown.classList.remove('show');
                return;
            }

            citySearchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch('/api/weather/cities?q=' + encodeURIComponent(query));
                    const data = await response.json();

                    if (data.success && data.cities.length > 0) {
                        dropdown.innerHTML = data.cities.map(city =>
                            '<div class="city-option" data-lat="' + city.lat + '" data-lon="' + city.lon + '" data-name="' + city.display_name + '" data-tz="' + (city.timezone || 'auto') + '">' + city.display_name + '</div>'
                        ).join('');
                        dropdown.classList.add('show');
                    } else {
                        dropdown.classList.remove('show');
                    }
                } catch (error) {
                    console.error('City search error:', error);
                    dropdown.classList.remove('show');
                }
            }, 300);
        });

        document.getElementById('cityDropdown').addEventListener('click', (e) => {
            if (e.target.classList.contains('city-option')) {
                document.getElementById('weatherCityName').value = e.target.dataset.name;
                document.getElementById('weatherCity').value = e.target.dataset.name;
                document.getElementById('weatherLatitude').value = e.target.dataset.lat;
                document.getElementById('weatherLongitude').value = e.target.dataset.lon;
                document.getElementById('weatherTimezone').value = e.target.dataset.tz || 'auto';
                document.getElementById('cityDropdown').classList.remove('show');
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.setting-item')) {
                document.getElementById('cityDropdown').classList.remove('show');
            }
        });

        function toggleWeatherSettings() {
            const settings = document.getElementById('weatherSettings');
            settings.classList.toggle('show');
            if (settings.classList.contains('show')) {
                loadWeatherConfig();
            }
        }

        document.getElementById('weatherSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const lat = document.getElementById('weatherLatitude').value;
            const lon = document.getElementById('weatherLongitude').value;

            const tiltVal = document.getElementById('weatherPanelTilt').value;
            const azimuthVal = document.getElementById('weatherPanelAzimuth').value;

            const payload = {
                enabled: document.getElementById('weatherEnabled').checked,
                city_name: document.getElementById('weatherCityName').value || '',
                latitude: lat ? parseFloat(lat) : null,
                longitude: lon ? parseFloat(lon) : null,
                timezone: document.getElementById('weatherTimezone').value || 'auto',
                min_solar_threshold_kwh: parseFloat(document.getElementById('weatherSolarThreshold').value) || 15,
                inverter_capacity_kw: parseFloat(document.getElementById('weatherInverterCapacity').value) || 0,
                panel_capacity_kw: parseFloat(document.getElementById('weatherPanelCapacity').value) || 0,
                panel_tilt: tiltVal ? parseInt(tiltVal) : null,
                panel_azimuth: azimuthVal !== '' ? parseInt(azimuthVal) : null
            };

            try {
                const response = await fetch('/api/weather/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (data.success) {
                    showToast('Weather settings saved');
                    toggleWeatherSettings();
                    refreshWeather();
                } else {
                    showToast(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        });

        // Initial weather load
        refreshWeather();
        // Refresh weather every 5 minutes
        setInterval(refreshWeather, 300000);

        // Free Energy functionality
        async function loadFreeEnergyConfig() {
            try {
                const response = await fetch('/api/free-energy/config');
                const config = await response.json();

                document.getElementById('freeEnergyEnabled').checked = config.enabled;
                document.getElementById('freeEnergyStart').value = config.start_time || '11:00';
                document.getElementById('freeEnergyEnd').value = config.end_time || '14:00';
                document.getElementById('freeEnergyTargetSoc').value = config.target_soc || 100;
            } catch (error) {
                console.error('Error loading free energy config:', error);
            }
        }

        // Load free energy config on page load
        loadFreeEnergyConfig();

        document.getElementById('freeEnergySettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const payload = {
                enabled: document.getElementById('freeEnergyEnabled').checked,
                start_time: document.getElementById('freeEnergyStart').value,
                end_time: document.getElementById('freeEnergyEnd').value,
                target_soc: parseInt(document.getElementById('freeEnergyTargetSoc').value) || 100,
                update_tou: true
            };

            try {
                const response = await fetch('/api/free-energy/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (data.success) {
                    showToast('Free energy settings saved');
                    toggleFreeEnergySettings();
                    refreshFreeEnergy();
                    refreshStatus();
                } else {
                    showToast(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        });

        // Initial free energy load
        refreshFreeEnergy();
    </script>
</body>
</html>
